/*
 (c) 2011-2013, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 Built on 22-04-2014 | https://github.com/kothic/kothic-js
*/
var Kothic={render:function(a,b,c,d){"string"==typeof a&&(a=document.getElementById(a));var e=d&&d.styles||[];MapCSS.locales=d&&d.locales||[];var f=Math.max(window.devicePixelRatio||1,2),g=a.width,h=a.height;1!==f&&(a.style.width=g+"px",a.style.height=h+"px",a.width=a.width*f,a.height=a.height*f);var i=a.getContext("2d");i.scale(f,f);var j=b.granularity,k=g/j,l=h/j,m=new Kothic.CollisionBuffer(h,g);console.time("styles");var n=Kothic.style.populateLayers(b.features,c,e),o=Kothic.getLayerIds(n);Kothic.style.setStyles(i,Kothic.style.defaultCanvasStyles),console.timeEnd("styles"),Kothic.getFrame(function(){console.time("geometry"),Kothic._renderBackground(i,g,h,c,e),Kothic._renderGeometryFeatures(o,n,i,k,l,j),d&&d.onRenderComplete&&d.onRenderComplete(),console.timeEnd("geometry"),Kothic.getFrame(function(){console.time("text/icons"),Kothic._renderTextAndIcons(o,n,i,k,l,m),console.timeEnd("text/icons")})})},_renderCollisions:function(a,b){var c,d,e;if(b.leaf)for(c=0,d=b.children.length;d>c;c++)a.strokeStyle="red",a.lineWidth=1,e=b.children[c],a.strokeRect(Math.round(e[0]),Math.round(e[1]),Math.round(e[2]-e[0]),Math.round(e[3]-e[1]));else for(c=0,d=b.children.length;d>c;c++)this._renderCollisions(a,b.children[c])},getLayerIds:function(a){return Object.keys(a).sort(function(a,b){return parseInt(a,10)-parseInt(b,10)})},getFrame:function(a){var b=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;b.call(window,a)},_renderBackground:function(a,b,c,d,e){var f=MapCSS.restyle(e,{},{},d,"canvas","canvas"),g=function(){a.fillRect(-1,-1,b+1,c+1)};for(var h in f)Kothic.polygon.fill(a,f[h],g)},_renderGeometryFeatures:function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n={};for(g=0;g<a.length;g++)for(j=b[a[g]],m=n._bg=n._bg||{},l=n[a[g]]=n[a[g]]||{},h=0,i=j.length;i>h;h++)k=j[h].style,("fill-color"in k||"fill-image"in k)&&("background"===k["fill-position"]?(m.polygons=m.polygons||[],m.polygons.push(j[h])):(l.polygons=l.polygons||[],l.polygons.push(j[h])));for(g=0;g<a.length;g++)for(j=b[a[g]],l=n[a[g]]=n[a[g]]||{},h=0,i=j.length;i>h;h++)"casing-width"in j[h].style&&(l.casings=l.casings||[],l.casings.push(j[h]));for(g=0;g<a.length;g++)for(j=b[a[g]],l=n[a[g]]=n[a[g]]||{},h=0,i=j.length;i>h;h++)"width"in j[h].style&&(l.lines=l.lines||[],l.lines.push(j[h]));for(a=["_bg"].concat(a),g=0;g<a.length;g++){if(l=n[a[g]],l.polygons)for(h=0,i=l.polygons.length;i>h;h++)Kothic.polygon.render(c,l.polygons[h],l.polygons[h+1],d,e,f);if(l.casings)for(c.lineCap="butt",h=0,i=l.casings.length;i>h;h++)Kothic.line.renderCasing(c,l.casings[h],l.casings[h+1],d,e,f);if(l.lines)for(c.lineCap="round",h=0,i=l.lines.length;i>h;h++)Kothic.line.render(c,l.lines[h],l.lines[h+1],d,e,f)}},_renderTextAndIcons:function(a,b,c,d,e,f){var g,h,i,j=[];for(i=0;i<a.length;i++){var k=b[a[i]],l=k.length;for(g=l-1;g>=0;g--)h=k[g].style,h.hasOwnProperty("icon-image")&&!h.text&&Kothic.texticons.render(c,k[g],f,d,e,!1,!0);for(g=l-1;g>=0;g--)h=k[g].style,!h.hasOwnProperty("icon-image")&&h.text&&Kothic.texticons.render(c,k[g],f,d,e,!0,!1);for(g=l-1;g>=0;g--)h=k[g].style,h.hasOwnProperty("icon-image")&&h.text&&Kothic.texticons.render(c,k[g],f,d,e,!0,!0);for(g=l-1;g>=0;g--)h=k[g].style,h["shield-text"]&&Kothic.shields.render(c,k[g],f,d,e)}return j}};Kothic.line={renderCasing:function(a,b,c,d,e,f){var g=b.style,h=c&&c.style;this.pathOpened||(this.pathOpened=!0,a.beginPath()),Kothic.path(a,b,g["casing-dashes"]||g.dashes,!1,d,e,f),c&&h.width===g.width&&h["casing-width"]===g["casing-width"]&&h["casing-color"]===g["casing-color"]&&h["casing-dashes"]===g["casing-dashes"]&&h["casing-opacity"]===g["casing-opacity"]||(Kothic.style.setStyles(a,{lineWidth:2*g["casing-width"]+(g.hasOwnProperty("width")?g.width:0),strokeStyle:g["casing-color"]||"#000000",lineCap:g["casing-linecap"]||g.linecap||"butt",lineJoin:g["casing-linejoin"]||g.linejoin||"round",globalAlpha:g["casing-opacity"]||1}),a.stroke(),this.pathOpened=!1)},render:function(a,b,c,d,e,f){var g=b.style,h=c&&c.style;if(this.pathOpened||(this.pathOpened=!0,a.beginPath()),Kothic.path(a,b,g.dashes,!1,d,e,f),!c||h.width!==g.width||h.color!==g.color||h.image!==g.image||h.opacity!==g.opacity){if("color"in g||!("image"in g)){var i=g.width||1,j="round",k="round";2>=i&&(j="miter",k="butt"),Kothic.style.setStyles(a,{lineWidth:i,strokeStyle:g.color||"#000000",lineCap:g.linecap||k,lineJoin:g.linejoin||j,globalAlpha:g.opacity||1,miterLimit:4}),a.stroke()}if("image"in g){var l=MapCSS.getImage(g.image);l&&(Kothic.style.setStyles(a,{strokeStyle:a.createPattern(l,"repeat")||"#000000",lineWidth:g.width||1,lineCap:g.linecap||"round",lineJoin:g.linejoin||"round",globalAlpha:g.opacity||1}),a.stroke())}this.pathOpened=!1}},pathOpened:!1},Kothic.path=function(){function a(a,b){e={pattern:b,seg:0,phs:0,x:a[0],y:a[1]}}function b(b,c,d){b.moveTo(c[0],c[1]),d&&a(c,d)}function c(a,b){var c,d,f,g=e,h=b[0]-g.x,i=b[1]-g.y,j=Math.sqrt(h*h+i*i);a.save(),a.translate(g.x,g.y),a.rotate(Math.atan2(i,h)),a.moveTo(0,0),c=0;do f=g.pattern[g.seg],c+=f-g.phs,d=j>c,d||(g.phs=f-(c-j),c=j),a[g.seg%2?"moveTo":"lineTo"](c,0),d&&(g.phs=0,g.seg=++g.seg%g.pattern.length);while(d);g.x=b[0],g.y=b[1],a.restore()}function d(a,b){return 0===a[0]||a[0]===b||0===a[1]||a[1]===b}var e;return function(a,e,f,g,h,i,j){var k=e.type,l=e.coordinates;"Polygon"===k&&(l=[l],k="MultiPolygon"),"LineString"===k&&(l=[l],k="MultiLineString");var m,n,o,p,q,r,s,t,u,v,w,x,y=l.length,z=50;if("MultiPolygon"===k)for(m=0;y>m;m++)for(o=0,q=l[m].length;q>o;o++)for(p=l[m][o],r=p.length,s=p[0],n=0;r>=n;n++)t=p[n]||p[0],u=Kothic.geom.transformPoint(t,h,i),0===n||!g&&d(t,j)&&d(s,j)?b(a,u,f):g||!f?a.lineTo(u[0],u[1]):c(a,u),s=t;if("MultiLineString"===k)for(m=0;y>m;m++)for(p=l[m],r=p.length,n=0;r>n;n++)t=p[n],u=Kothic.geom.transformPoint(t,h,i),0!==n&&n!==r-1||!d(t,j)||(s=p[n?r-2:1],v=t[0]-s[0],w=t[1]-s[1],x=Math.sqrt(v*v+w*w),u[0]=u[0]+z*v/x,u[1]=u[1]+z*w/x),0===n?b(a,u,f):f?c(a,u):a.lineTo(u[0],u[1])}}(),Kothic.polygon={render:function(a,b,c,d,e,f){var g=b.style,h=c&&c.style;this.pathOpened||(this.pathOpened=!0,a.beginPath()),Kothic.path(a,b,!1,!0,d,e,f),c&&h["fill-color"]===g["fill-color"]&&h["fill-image"]===g["fill-image"]&&h["fill-opacity"]===g["fill-opacity"]||(this.fill(a,g),this.pathOpened=!1)},fill:function(a,b,c){var d,e=b["fill-opacity"]||b.opacity;b.hasOwnProperty("fill-color")&&(Kothic.style.setStyles(a,{fillStyle:b["fill-color"]||"#000000",globalAlpha:e||1}),c?c():a.fill()),b.hasOwnProperty("fill-image")&&(d=MapCSS.getImage(b["fill-image"]),d&&(Kothic.style.setStyles(a,{fillStyle:a.createPattern(d,"repeat"),globalAlpha:e||1}),c?c():a.fill()))}},Kothic.shields={render:function(a,b,c,d,e){var f,g,h,i,j=b.style,k=Kothic.geom.getReprPoint(b),l=0,m=!1;if(k&&(f=Kothic.geom.transformPoint(k,d,e),!j["shield-image"]||(g=MapCSS.getImage(j["icon-image"])))){Kothic.style.setStyles(a,{font:Kothic.style.getFontString(j["shield-font-family"]||j["font-family"],j["shield-font-size"]||j["font-size"]),fillStyle:j["shield-text-color"]||"#000000",globalAlpha:j["shield-text-opacity"]||j.opacity||1,textAlign:"center",textBaseline:"middle"});var n=String(j["shield-text"]),o=a.measureText(n).width,p=o/n.length,q=o+2,r=1.8*p;if("LineString"===b.type){if(l=Kothic.geom.getPolyLength(b.coordinates),Math.max(r/e,q/d)>l)return;for(h=0,i=1;l/2>h&&(k=Kothic.geom.getAngleAndCoordsAtLength(b.coordinates,l/2+i*h,0),k);h+=Math.max(l/30,r/d),i*=-1)if(k=[k[1],k[2]],f=Kothic.geom.transformPoint(k,d,e),!(g&&"true"!==j["allow-overlap"]&&c.checkPointWH(f,g.width,g.height,b.kothicId)||"true"!==j["allow-overlap"]&&c.checkPointWH(f,q,r,b.kothicId))){m=!0;break}}m&&(j["shield-casing-width"]&&(Kothic.style.setStyles(a,{fillStyle:j["shield-casing-color"]||"#000000",globalAlpha:j["shield-casing-opacity"]||j.opacity||1}),a.fillRect(f[0]-q/2-(j["shield-casing-width"]||0)-(j["shield-frame-width"]||0),f[1]-r/2-(j["shield-casing-width"]||0)-(j["shield-frame-width"]||0),q+2*(j["shield-casing-width"]||0)+2*(j["shield-frame-width"]||0),r+2*(j["shield-casing-width"]||0)+2*(j["shield-frame-width"]||0))),j["shield-frame-width"]&&(Kothic.style.setStyles(a,{fillStyle:j["shield-frame-color"]||"#000000",globalAlpha:j["shield-frame-opacity"]||j.opacity||1}),a.fillRect(f[0]-q/2-(j["shield-frame-width"]||0),f[1]-r/2-(j["shield-frame-width"]||0),q+2*(j["shield-frame-width"]||0),r+2*(j["shield-frame-width"]||0))),j["shield-color"]&&(Kothic.style.setStyles(a,{fillStyle:j["shield-color"]||"#000000",globalAlpha:j["shield-opacity"]||j.opacity||1}),a.fillRect(f[0]-q/2,f[1]-r/2,q,r)),g&&a.drawImage(g,Math.floor(f[0]-g.width/2),Math.floor(f[1]-g.height/2)),Kothic.style.setStyles(a,{fillStyle:j["shield-text-color"]||"#000000",globalAlpha:j["shield-text-opacity"]||j.opacity||1}),a.fillText(n,f[0],Math.ceil(f[1])),g&&c.addPointWH(f,g.width,g.height,0,b.kothicId),c.addPointWH(f,r,q,(parseFloat(j["shield-casing-width"])||0)+(parseFloat(j["shield-frame-width"])||0)+(parseFloat(j["-x-mapnik-min-distance"])||30),b.kothicId))}}},Kothic.textOnPath=function(){function a(a,b){return a.measureText(b).width}function b(a,b){return[a[1]+.5*Math.cos(a[0])*b,a[2]+.5*Math.sin(a[0])*b]}function c(a,c,d){var e=1.5*a,f=Math.abs(Math.cos(c[0])),g=Math.abs(Math.sin(c[0])),h=f*a+g*e,i=g*a+f*e;return[b(c,a+2*(d||0)),h,i,0]}function d(b,d,e,f,g){for(var h=a(d,e),i=0;h>i;i+=g)if(b.checkPointWH.apply(b,c(g,f,i)))return!0;return!1}function e(b,d,e,f,g){for(var h=a(d,e),i=[],j=0;h>j;j+=g)i.push(c(g,f,j));b.addPoints(i)}function f(c,d,e){var f=d[4],g=b(d,a(c,f));c.translate(g[0],g[1]),c.rotate(d[0]),c[e?"strokeText":"fillText"](f,0,0),c.rotate(-d[0]),c.translate(-g[0],-g[1])}return function(b,c,g,h,i){var j=b.measureText(g).width,k=g.length,l=Kothic.geom.getPolyLength(c);if(!(j>l)){for(var m,n,o,p,q,r,s,t,u=a(b,"a"),v=0,w=!1,x=Math.PI/6;2>v;){for(n=v?a(b,g.charAt(0)):(l-j)/2,q=0,o=null,p=[],t=0;k>t;t++){if(m=g.charAt(t),s=a(b,m),r=Kothic.geom.getAngleAndCoordsAtLength(c,n,s),n>=l||!r){v++,p=[],w&&(c.reverse(),w=!1);break}if(o||(o=r[0]),d(i,b,m,r,u)||Math.abs(o-r[0])>x)n+=s,t=-1,p=[],q=0;else{for(;s<r[3]&&k>t;){if(t++,m+=g.charAt(t),s=a(b,m),d(i,b,m,r,u)){t=0,n+=s,p=[],q=0,m=g.charAt(t),s=a(b,m),r=Kothic.geom.getAngleAndCoordsAtLength(c,n,s);break}if(s>=r[3]){t--,m=m.slice(0,-1),s=a(b,m);break}}r&&((r[0]>Math.PI/2||r[0]<-Math.PI/2)&&(q+=m.length),o=r[0],r.push(m),p.push(r),n+=s)}}if(q>k/2&&(c.reverse(),p=[],w?(v++,c.reverse(),w=!1):w=!0),v>=2)return;if(p.length>0)break}var y=p.length;for(t=0;h&&y>t;t++)f(b,p[t],!0);for(t=0;y>t;t++)r=p[t],f(b,r),e(i,b,r[4],r,u)}}}(),Kothic.texticons={render:function(a,b,c,d,e,f,g){var h,i,j,k,l=b.style;if(g||f&&"LineString"!==b.type){var m=Kothic.geom.getReprPoint(b);if(!m)return;i=Kothic.geom.transformPoint(m,d,e)}if(g){if(h=MapCSS.getImage(l["icon-image"]),!h)return;if(j=h.width,k=h.height,(l["icon-width"]||l["icon-height"])&&(l["icon-width"]&&(j=l["icon-width"],k=h.height*j/h.width),l["icon-height"]&&(k=l["icon-height"],l["icon-width"]||(j=h.width*k/h.height))),"true"!==l["allow-overlap"]&&c.checkPointWH(i,j,k,b.kothicId))return}if(f){Kothic.style.setStyles(a,{lineWidth:2*l["text-halo-radius"],font:Kothic.style.getFontString(l["font-family"],l["font-size"])});var n=String(l.text),o=a.measureText(n).width,p=o/n.length,q=o,r=2.5*p,s=l["text-offset"]||0,t=l.hasOwnProperty("text-halo-radius");if(Kothic.style.setStyles(a,{fillStyle:l["text-color"]||"#000000",strokeStyle:l["text-halo-color"]||"#ffffff",globalAlpha:l["text-opacity"]||l.opacity||1,textAlign:"center",textBaseline:"middle"}),"Polygon"===b.type||"Point"===b.type){if("true"!==l["text-allow-overlap"]&&c.checkPointWH([i[0],i[1]+s],q,r,b.kothicId))return;t&&a.strokeText(n,i[0],i[1]+s),a.fillText(n,i[0],i[1]+s);var u=l["-x-kot-min-distance"]||20;c.addPointWH([i[0],i[1]+s],q,r,u,b.kothicId)}else if("LineString"===b.type){var v=Kothic.geom.transformPoints(b.coordinates,d,e);Kothic.textOnPath(a,v,n,t,c)}}if(g){a.drawImage(h,Math.floor(i[0]-j/2),Math.floor(i[1]-k/2),j,k);var w=parseFloat(l["-x-kot-min-distance"])||0;c.addPointWH(i,j,k,w,b.kothicId)}}};var MapCSS={styles:{},availableStyles:[],images:{},locales:[],presence_tags:[],value_tags:[],cache:{},debug:{hit:0,miss:0},onError:function(){},onImagesLoad:function(){},invalidateCache:function(){this.cache={}},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){var a;for(a=0;a<arguments.length;a++)if("undefined"!=typeof arguments[a]&&""!==arguments[a])return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,b){return a.hasOwnProperty(b)&&null!==a[b]?b:""},e_prop:function(a,b){return a.hasOwnProperty(b)&&null!==a[b]?a[b]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a,b,c){return"undefined"==typeof b&&(b="true"),"undefined"==typeof c&&(c="false"),"0"===a||"false"===a||""===a?c:b},e_metric:function(a){return/\d\s*mm$/.test(a)?1e3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?.001*parseInt(a,10):/\d\s*in$/.test(a)?.0254*parseInt(a,10):/\d\s*ft$/.test(a)?.3048*parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.e_metric(a)},e_localize:function(a,b){var c,d,e=MapCSS.locales;for(c=0;c<e.length;c++)if(d=b+":"+e[c],a[d])return a[d];return a[b]},loadStyle:function(a,b,c,d,e,f){var g;if(c=c||[],d=d||[],e)for(g=0;g<e.length;g++)this.presence_tags.indexOf(e[g])<0&&this.presence_tags.push(e[g]);if(f)for(g=0;g<f.length;g++)this.value_tags.indexOf(f[g])<0&&this.value_tags.push(f[g]);MapCSS.styles[a]={restyle:b,images:c,external_images:d,textures:{},sprite_loaded:!c,external_images_loaded:!d.length},MapCSS.availableStyles.push(a)},_onImagesLoad:function(a){MapCSS.styles[a].external_images_loaded&&MapCSS.styles[a].sprite_loaded&&MapCSS.onImagesLoad()},preloadSpriteImage:function(a,b){var c=MapCSS.styles[a].images,d=new Image;delete MapCSS.styles[a].images,d.onload=function(){var b;for(b in c)c.hasOwnProperty(b)&&(c[b].sprite=d,MapCSS.images[b]=c[b]);MapCSS.styles[a].sprite_loaded=!0,MapCSS._onImagesLoad(a)},d.onerror=function(a){MapCSS.onError(a)},d.src=b},preloadExternalImages:function(a,b){function c(b){var c=new Image;c.onload=function(){g++,MapCSS.images[b]={sprite:c,height:c.height,width:c.width,offset:0},g===f&&(MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a))},c.onerror=function(){g++,g===f&&(MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a))},c.src=b}var d=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images,b=b||"";var e,f=d.length,g=0;for(e=0;f>e;e++)c(b+d[e])},getImage:function(a){var b=MapCSS.images[a];if(b&&b.sprite){var c=document.createElement("canvas");c.width=b.width,c.height=b.height,c.getContext("2d").drawImage(b.sprite,0,b.offset,b.width,b.height,0,0,b.width,b.height),b=MapCSS.images[a]=c}return b},getTagKeys:function(a,b,c,d){var e,f=[];for(e=0;e<this.presence_tags.length;e++)a.hasOwnProperty(this.presence_tags[e])&&f.push(this.presence_tags[e]);for(e=0;e<this.value_tags.length;e++)a.hasOwnProperty(this.value_tags[e])&&f.push(this.value_tags[e]+":"+a[this.value_tags[e]]);return[b,c,d,f.join(":")].join(":")},restyle:function(a,b,c,d,e){var f,g=this.getTagKeys(b,c,d,e),h=this.cache[g]||{};if(this.cache.hasOwnProperty(g))this.debug.hit+=1;else{for(this.debug.miss+=1,f=0;f<a.length;f++)h=MapCSS.styles[a[f]].restyle(h,b,c,d,e);this.cache[g]=h}return h}};Kothic.style={defaultCanvasStyles:{strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round",textAlign:"center",textBaseline:"middle"},populateLayers:function(a,b,c){var d,e,f,g,h,i={},j=Kothic.style.styleFeatures(a,b,c);for(d=0,e=j.length;e>d;d++)f=j[d],h=f.style["-x-mapnik-layer"],g=h?"top"===h?1e4:-1e4:f.properties.layer||0,i[g]=i[g]||[],i[g].push(f);return i},getStyle:function(a,b,c){var d,e,f=a.type;return"LineString"===f||"MultiLineString"===f?(d="way",e="line"):"Polygon"===f||"MultiPolygon"===f?(d="way",e="area"):("Point"===f||"MultiPoint"===f)&&(d="node",e="node"),MapCSS.restyle(c,a.properties,b,d,e)},styleFeatures:function(a,b,c){var d,e,f,g,h,i,j,k=[];for(d=0,f=a.length;f>d;d++){g=a[d],h=this.getStyle(g,b,c);for(e in h){if("default"===e)i=g;else{i={};for(j in g)i[j]=g[j]}i.kothicId=d+1,i.style=h[e],i.zIndex=h[e]["z-index"]||0,i.sortKey=(h[e]["fill-color"]||"")+(h[e].color||""),k.push(i)}}return k.sort(function(a,b){return a.zIndex!==b.zIndex?a.zIndex-b.zIndex:a.sortKey<b.sortKey?-1:a.sortKey>b.sortKey?1:0}),k},getFontString:function(a,b){a=a||"",b=b||9;var c=a?a+", ":"";a=a.toLowerCase();var d=[];return(-1!==a.indexOf("italic")||-1!==a.indexOf("oblique"))&&d.push("italic"),-1!==a.indexOf("bold")&&(d.push("bold"),c+=a.replace("bold","")+", "),d.push(b+"px"),c+=-1!==a.indexOf("serif")?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif',d.push(c),d.join(" ")},setStyles:function(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}},Kothic.CollisionBuffer=function(a,b){this.buffer=rbush(),this.height=a,this.width=b},Kothic.CollisionBuffer.prototype={addPointWH:function(a,b,c,d,e){this.buffer.insert(this.getBoxFromPoint(a,b,c,d,e))},addPoints:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this.getBoxFromPoint.apply(this,a[c]));this.buffer.load(b)},checkBox:function(a,b){var c,d,e=this.buffer.search(a);if(a[0]<0||a[1]<0||a[2]>this.width||a[3]>this.height)return!0;for(c=0,d=e.length;d>c;c++)if(b!==e[c][4])return!0;return!1},checkPointWH:function(a,b,c,d){return this.checkBox(this.getBoxFromPoint(a,b,c,0),d)},getBoxFromPoint:function(a,b,c,d,e){var f=b/2+d,g=c/2+d;return[a[0]-f,a[1]-g,a[0]+f,a[1]+g,e]}},Kothic.geom={transformPoint:function(a,b,c){return[b*a[0],c*a[1]]},transformPoints:function(a,b,c){var d,e,f=[];for(d=0,e=a.length;e>d;d++)f.push(this.transformPoint(a[d],b,c));return f},getReprPoint:function(a){var b,c;switch(a.type){case"Point":b=a.coordinates;break;case"Polygon":b=a.reprpoint;break;case"LineString":c=Kothic.geom.getPolyLength(a.coordinates),b=Kothic.geom.getAngleAndCoordsAtLength(a.coordinates,c/2,0),b=[b[1],b[2]];break;case"GeometryCollection":return;case"MultiPoint":return;case"MultiPolygon":b=a.reprpoint;break;case"MultiLineString":return}return b},getPolyLength:function(a){var b,c,d,e,f,g=a.length,h=0;for(d=1;g>d;d++)b=a[d],c=a[d-1],e=c[0]-b[0],f=c[1]-b[1],h+=Math.sqrt(e*e+f*f);return h},getAngleAndCoordsAtLength:function(a,b,c){var d,e,f,g,h,i,j,k,l,m=a.length,n=0,o=0,p=!0,q=!1;for(c=c||0,h=1;m>h;h++){if(q&&(p=!1),i=a[h],j=a[h-1],d=i[0]-j[0],e=i[1]-j[1],o=Math.sqrt(d*d+e*e),!q&&n+o>=b&&(l=b-n,f=j[0]+d*l/o,g=j[1]+e*l/o,q=!0),q&&n+o>=b+c)return l=b+c-n,d=j[0]+d*l/o,e=j[1]+e*l/o,k=Math.atan2(e-g,d-f),p?[k,f,g,o-l]:[k,f,g,0];n+=o}}},function(){"use strict";function a(b,c){return this instanceof a?(this._maxEntries=Math.max(4,b||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this._initFormat(c),void this.clear()):new a(b,c)}a.prototype={search:function(a){var b=this.data,c=[];if(!this._intersects(a,b.bbox))return c;for(var d,e,f,g,h=[];b;){for(d=0,e=b.children.length;e>d;d++)f=b.children[d],g=b.leaf?this._toBBox(f):f.bbox,this._intersects(a,g)&&(b.leaf?c:h).push(f);b=h.pop()}return c},load:function(a){if(!a||!a.length)return this;if(a.length<this._minEntries){for(var b=0,c=a.length;c>b;b++)this.insert(a[b]);return this}var d=this._build(a.slice(),0);if(this._calcBBoxes(d,!0),this.data.children.length)if(this.data.height===d.height)this._splitRoot(this.data,d);else{if(this.data.height<d.height){var e=this.data;this.data=d,d=e}this._insert(d,this.data.height-d.height-1,!0)}else this.data=d;return this},insert:function(a){return a&&this._insert(a,this.data.height-1),this},clear:function(){return this.data={children:[],leaf:!0,bbox:this._infinite(),height:1},this},remove:function(a){if(!a)return this;for(var b,c,d,e,f=this.data,g=this._toBBox(a),h=[],i=[];f||h.length;){if(f||(f=h.pop(),c=h[h.length-1],b=i.pop(),e=!0),f.leaf&&(d=f.children.indexOf(a),-1!==d))return f.children.splice(d,1),h.push(f),this._condense(h),this;e||f.leaf||!this._intersects(g,f.bbox)?c?(b++,f=c.children[b],e=!1):f=null:(h.push(f),i.push(b),b=0,c=f,f=f.children[0])}return this},toJSON:function(){return this.data},fromJSON:function(a){return this.data=a,this},_build:function(a,b,c){var d=a.length,e=this._maxEntries;if(e>=d)return{children:a,leaf:!0,height:1};b||(c=Math.ceil(Math.log(d)/Math.log(e)),e=Math.ceil(d/Math.pow(e,c-1)),a.sort(this._compareMinX));var f,g,h,i,j,k={children:[],height:c},l=Math.ceil(d/e)*Math.ceil(Math.sqrt(e)),m=Math.ceil(d/e),n=b%2===1?this._compareMinX:this._compareMinY;for(f=0;d>f;f+=l)for(h=a.slice(f,f+l).sort(n),g=0,i=h.length;i>g;g+=m)j=this._build(h.slice(g,g+m),b+1,c-1),k.children.push(j);return k},_chooseSubtree:function(a,b,c,d){for(var e,f,g,h,i,j,k,l;;){if(d.push(b),b.leaf||d.length-1===c)break;for(k=l=1/0,e=0,f=b.children.length;f>e;e++)g=b.children[e],i=this._area(g.bbox),j=this._enlargedArea(a,g.bbox)-i,l>j?(l=j,k=k>i?i:k,h=g):j===l&&k>i&&(k=i,h=g);b=h}return b},_insert:function(a,b,c,d){var e,f=c?a.bbox:this._toBBox(a),g=[],h=this._chooseSubtree(f,d||this.data,b,g);h.children.push(a),this._extend(h.bbox,f);do e=!1,g[b].children.length>this._maxEntries&&(this._split(g,b),e=!0,b--);while(b>=0&&e);this._adjustParentBBoxes(f,g,b)},_split:function(a,b){var c=a[b],d=c.children.length,e=this._minEntries;this._chooseSplitAxis(c,e,d);var f={children:c.children.splice(this._chooseSplitIndex(c,e,d)),height:c.height};c.leaf&&(f.leaf=!0),this._calcBBoxes(c),this._calcBBoxes(f),b?a[b-1].children.push(f):this._splitRoot(c,f)},_splitRoot:function(a,b){this.data={},this.data.children=[a,b],this.data.height=a.height+1,this._calcBBoxes(this.data)},_chooseSplitIndex:function(a,b,c){var d,e,f,g,h,i,j,k;for(i=j=1/0,d=b;c-b>=d;d++)e=this._distBBox(a,0,d),f=this._distBBox(a,d,c),g=this._intersectionArea(e,f),h=this._area(e)+this._area(f),i>g?(i=g,k=d,j=j>h?h:j):g===i&&j>h&&(j=h,k=d);return k},_chooseSplitAxis:function(a,b,c){var d=a.leaf?this._compareMinX:this._compareNodeMinX,e=a.leaf?this._compareMinY:this._compareNodeMinY,f=this._allDistMargin(a,b,c,d),g=this._allDistMargin(a,b,c,e);g>f&&a.children.sort(d)},_allDistMargin:function(a,b,c,d){a.children.sort(d);var e,f,g=this._distBBox(a,0,b),h=this._distBBox(a,c-b,c),i=this._margin(g)+this._margin(h);for(e=b;c-b>e;e++)f=a.children[e],this._extend(g,a.leaf?this._toBBox(f):f.bbox),i+=this._margin(g);for(e=c-b-1;e>=0;e--)f=a.children[e],this._extend(h,a.leaf?this._toBBox(f):f.bbox),i+=this._margin(h);return i},_distBBox:function(a,b,c){for(var d,e=this._infinite(),f=b;c>f;f++)d=a.children[f],this._extend(e,a.leaf?this._toBBox(d):d.bbox);return e},_calcBBoxes:function(a,b){a.bbox=this._infinite();for(var c,d=0,e=a.children.length;e>d;d++)c=a.children[d],a.leaf?this._extend(a.bbox,this._toBBox(c)):(b&&this._calcBBoxes(c,b),this._extend(a.bbox,c.bbox))},_adjustParentBBoxes:function(a,b,c){for(var d=c;d>=0;d--)this._extend(b[d].bbox,a)},_condense:function(a){for(var b,c=a.length-1;c>=0;c--)c>0&&0===a[c].children.length?(b=a[c-1].children,b.splice(b.indexOf(a[c]),1)):this._calcBBoxes(a[c])},_intersects:function(a,b){return b[0]<=a[2]&&b[1]<=a[3]&&b[2]>=a[0]&&b[3]>=a[1]},_extend:function(a,b){return a[0]=Math.min(a[0],b[0]),a[1]=Math.min(a[1],b[1]),a[2]=Math.max(a[2],b[2]),a[3]=Math.max(a[3],b[3]),a},_area:function(a){return(a[2]-a[0])*(a[3]-a[1])},_margin:function(a){return a[2]-a[0]+(a[3]-a[1])},_enlargedArea:function(a,b){return(Math.max(b[2],a[2])-Math.min(b[0],a[0]))*(Math.max(b[3],a[3])-Math.min(b[1],a[1]))},_intersectionArea:function(a,b){var c=Math.max(a[0],b[0]),d=Math.max(a[1],b[1]),e=Math.min(a[2],b[2]),f=Math.min(a[3],b[3]);return Math.max(0,e-c)*Math.max(0,f-d)},_infinite:function(){return[1/0,1/0,-1/0,-1/0]},_compareNodeMinX:function(a,b){return a.bbox[0]-b.bbox[0]},_compareNodeMinY:function(a,b){return a.bbox[1]-b.bbox[1]},_initFormat:function(a){a=a||["[0]","[1]","[2]","[3]"];var b=["return a"," - b",";"];this._compareMinX=new Function("a","b",b.join(a[0])),this._compareMinY=new Function("a","b",b.join(a[1])),this._toBBox=new Function("a","return [a"+a.join(", a")+"];")}},"undefined"!=typeof module?module.exports=a:window.rbush=a}();